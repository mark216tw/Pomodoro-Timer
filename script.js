/**
 * Â•ΩÁî®ÁöÑÁï™ËåÑÊôÇÈêò -Ê†∏ÂøÉÈÇèËºØ
 */

// --- 1. Â∏∏Êï∏ËàáÈ†êË®≠Ë®≠ÂÆö ---
let workMinutes = parseInt(localStorage.getItem('pomoWorkMinutes')) || 25;
let breakMinutes = parseInt(localStorage.getItem('pomoBreakMinutes')) || 5;
let soundEnabled = localStorage.getItem('pomoSoundEnabled') !== 'false'; // È†êË®≠ÈñãÂïü

// Base64 ÊèêÁ§∫Èü≥ (ÂÑ™ÈõÖÁöÑÂèÆËÅ≤)
const ALERT_SOUND_B64 = "data:audio/mp3;base64,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Ax/8iIr//RMfEyAx//mQGSAx/8iIr//RMfEyAx//mQGSAx/8iIr//RMfEyAx//mQGSAx/8iIr//RMfEyAx//mQGSAx/8iIr//RMfEyAx//mQGSAx/8iIr//RMfEyAx//mQGSAx/8iIr//RMfEyAx//mQGSAx/8iIr//RMfEyAx//mQGSAx/8iIr//RMfEyAx/80MUToAAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MUUMAAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MUYsAAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MUcsAAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MUgkAAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MUisAAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MUkUAAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MUm0AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MUn0AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MUo0AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MUp0AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MUq0AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MUr0AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MUs0AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MUt0AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MUu0AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MUv0AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MUw0AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MUx0AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MUy0AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MUz0AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MU00AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MU10AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MU20AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MU30AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MU40AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MU50AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MU60AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MU70AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MU80AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MU90AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MU+0AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/80MU/0AAADSAAAAIAAABpAAAFMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";

// --- 2. ÁãÄÊÖãÁÆ°ÁêÜ ---
let timeLeft = workMinutes * 60;
let timerId = null;
let isRunning = false;
let currentMode = 'work'; // 'work' | 'break'
let completedCount = parseInt(localStorage.getItem('pomoCompletedCount')) || 0;

// --- 3. DOM ÂÖÉÁ¥† ---
const timerDisplay = document.getElementById('timer');
const statusBadge = document.getElementById('status-badge');
const startBtn = document.getElementById('start-btn');
const pauseBtn = document.getElementById('pause-btn');
const resetBtn = document.getElementById('reset-btn');
const pomoCountDisplay = document.getElementById('pomo-count');
const clearStatsBtn = document.getElementById('clear-stats-btn');
const themeDots = document.querySelectorAll('.theme-dot');
const alertSound = document.getElementById('alert-sound');
const appContainer = document.getElementById('app');
const body = document.body;

// Ë®≠ÁΩÆËº∏ÂÖ•Ê°Ü
const workInput = document.getElementById('work-duration');
const breakInput = document.getElementById('break-duration');
const soundToggle = document.getElementById('sound-toggle');

// Modal Áõ∏Èóú
const confirmModal = document.getElementById('confirm-modal');
const modalCancel = document.getElementById('modal-cancel');
const modalConfirm = document.getElementById('modal-confirm');

// ÂàùÂßãÂåñÈü≥Êïà
alertSound.src = ALERT_SOUND_B64;

// --- 4. Ê†∏ÂøÉÂäüËÉΩ ---

/**
 * Êõ¥Êñ∞ÂÄíÊï∏È°ØÁ§∫ (MM:SS)
 */
function updateTimerDisplay() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    const displayStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    timerDisplay.textContent = displayStr;
    document.title = `${displayStr} - ${currentMode === 'work' ? 'Â∞àÊ≥®‰∏≠' : '‰ºëÊÅØ‰∏≠'}`;
}

/**
 * Êõ¥Êñ∞‰ªãÈù¢ÁãÄÊÖã (ÈÖçËâ≤„ÄÅÊñáÂ≠ó)
 */
function updateUIState() {
    if (currentMode === 'work') {
        body.className = 'mode-work';
        statusBadge.textContent = 'üçÖ Â∞àÊ≥®‰∏≠';
        statusBadge.style.backgroundColor = 'var(--accent-work)';
    } else {
        body.className = 'mode-break';
        statusBadge.textContent = '‚òï ‰ºëÊÅØ‰∏≠';
        statusBadge.style.backgroundColor = 'var(--accent-break)';
    }
    pomoCountDisplay.textContent = completedCount;
}

/**
 * ÂàáÊèõÊ®°Âºè (Â∑•‰Ωú <-> ‰ºëÊÅØ)
 */
function switchMode() {
    if (currentMode === 'work') {
        currentMode = 'break';
        timeLeft = breakMinutes * 60;
        completedCount++;
        localStorage.setItem('pomoCompletedCount', completedCount);
    } else {
        currentMode = 'work';
        timeLeft = workMinutes * 60;
    }

    if (soundEnabled) {
        alertSound.currentTime = 0;
        alertSound.play().catch(e => {
            console.warn("Èü≥ÊïàÊí≠ÊîæË¢´ÁÄèË¶ΩÂô®ÈòªÊìãÔºåÂ∞áÂú®‰∏ãÊ¨°‰ΩøÁî®ËÄÖ‰∫íÂãïÂæåËß£Èéñ„ÄÇ");
        });
    }
    updateUIState();
    updateTimerDisplay();
}

/**
 * Ë®àÊôÇÂô® Tick
 */
function tick() {
    if (timeLeft > 0) {
        timeLeft--;
        updateTimerDisplay();
    } else {
        clearInterval(timerId);
        timerId = null;
        isRunning = false;
        startBtn.style.display = 'inline-block';
        pauseBtn.style.display = 'none';
        appContainer.classList.remove('running');

        switchMode();
        // Ëá™ÂãïÈñãÂßã‰∏ã‰∏ÄÂÄãÈöéÊÆµ (ÂèØÈÅ∏ÔºåÈÄôË£°Ë®≠ÂÆöÁÇ∫Ëá™ÂãïÈñãÂßã)
        startTimer();
    }
}

/**
 * ÈñãÂßãË®àÊôÇ
 */
function startTimer() {
    // ÊØèÊ¨°ÈªûÊìäÈñãÂßãÊôÇÔºåÂòóË©¶Ëß∏ÁôºÊí≠Êîæ‰ª•Ëß£ÈéñÁÄèË¶ΩÂô®ÁöÑÈü≥ÊïàÈôêÂà∂
    if (!isRunning) {
        alertSound.play().then(() => {
            alertSound.pause(); // Á´ãÂç≥Êö´ÂÅúÔºåÂÉÖÁÇ∫‰∫ÜÂèñÂæóÊí≠ÊîæÊéàÊ¨ä
            alertSound.currentTime = 0;
        }).catch(() => { });
    }

    if (isRunning) return;

    isRunning = true;
    startBtn.style.display = 'none';
    pauseBtn.style.display = 'inline-block';
    appContainer.classList.add('running');

    timerId = setInterval(tick, 1000);
}

/**
 * Êö´ÂÅúË®àÊôÇ
 */
function pauseTimer() {
    isRunning = false;
    startBtn.style.display = 'inline-block';
    pauseBtn.style.display = 'none';
    appContainer.classList.remove('running');

    clearInterval(timerId);
    timerId = null;
}

/**
 * ÈáçÁΩÆË®àÊôÇ
 */
function resetTimer() {
    pauseTimer();
    currentMode = 'work';
    timeLeft = workMinutes * 60;
    updateUIState();
    updateTimerDisplay();
}

// --- 5. ‰∫ã‰ª∂Áõ£ËÅΩ (Event Listeners) ---

startBtn.addEventListener('click', startTimer);
pauseBtn.addEventListener('click', pauseTimer);
resetBtn.addEventListener('click', resetTimer);

// Ê∏ÖÈô§Á¥ÄÈåÑËàá Modal ÈÇèËºØ
clearStatsBtn.addEventListener('click', () => {
    confirmModal.style.display = 'flex';
});

modalCancel.addEventListener('click', () => {
    confirmModal.style.display = 'none';
});

modalConfirm.addEventListener('click', () => {
    completedCount = 0;
    localStorage.removeItem('pomoCompletedCount');
    updateUIState();
    confirmModal.style.display = 'none';
});

// ÈªûÊìä Modal Â§ñÈÉ®ÈóúÈñâ
window.addEventListener('click', (e) => {
    if (e.target === confirmModal) {
        confirmModal.style.display = 'none';
    }
});

// ‰∏ªÈ°åÂàáÊèõÈÇèËºØ
themeDots.forEach(dot => {
    dot.addEventListener('click', () => {
        const selectedTheme = dot.getAttribute('data-t');
        setTheme(selectedTheme);
    });
});

function setTheme(themeName) {
    document.documentElement.setAttribute('data-theme', themeName);
    localStorage.setItem('pomoTheme', themeName);

    // Êõ¥Êñ∞ÈªûÈªûÁöÑÂïüÂãïÁãÄÊÖã
    themeDots.forEach(d => {
        if (d.getAttribute('data-t') === themeName) {
            d.classList.add('active-theme');
        } else {
            d.classList.remove('active-theme');
        }
    });
}

// ÊôÇÈñìË®≠ÂÆöËÆäÊõ¥ÈÇèËºØ
workInput.addEventListener('change', () => {
    let val = parseInt(workInput.value);
    if (isNaN(val) || val < 1) val = 1;
    if (val > 60) val = 60;
    workInput.value = val;
    workMinutes = val;
    localStorage.setItem('pomoWorkMinutes', val);
    if (!isRunning && currentMode === 'work') {
        timeLeft = workMinutes * 60;
        updateTimerDisplay();
    }
});

breakInput.addEventListener('change', () => {
    let val = parseInt(breakInput.value);
    if (isNaN(val) || val < 1) val = 1;
    if (val > 60) val = 60;
    breakInput.value = val;
    breakMinutes = val;
    localStorage.setItem('pomoBreakMinutes', val);
    if (!isRunning && currentMode === 'break') {
        timeLeft = breakMinutes * 60;
        updateTimerDisplay();
    }
});

// Èü≥ÊïàÈñãÈóúÈÇèËºØ
soundToggle.addEventListener('change', () => {
    soundEnabled = soundToggle.checked;
    localStorage.setItem('pomoSoundEnabled', soundEnabled);
});

// --- 6. ÂàùÂßãÂåñ ---
(function init() {
    // ËºâÂÖ•‰∏ªÈ°å
    const savedTheme = localStorage.getItem('pomoTheme') || 'classic';
    setTheme(savedTheme);

    workInput.value = workMinutes;
    breakInput.value = breakMinutes;
    soundToggle.checked = soundEnabled;
    updateUIState();
    updateTimerDisplay();
})();
